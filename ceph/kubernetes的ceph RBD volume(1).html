kubernetes的ceph RBD volume(1)：使用Ceph RBD作为后端Volume<br/><br/><div class="article_content tracking-ad" data-dsm="post" data-mod="popu_307" id="article_content">

<p><br/>
</p>
<p><span style="background-color:rgb(255,255,255)"></span><br/>
</p>
<p>Kubernetes使用Ceph RBD作为后端Volume。 Kubernetes的官方源码 的examples/volumes/rbd目录下，就有一个使用cephrbd作为kubernetes pod volume的例子，我们可以参考<br/>
<br/>
<br/>
</p>
<p>1. 当ceph集群安装完成以后，我们就要创建相应的rbd块用于kubernetes存储。创建块设备之前，需要先创建存储池</p>
<p><br/>
ceph osd pool create kube 256 256 0202 #后面两个256分别为pg-num和pgp-num</p>
<p>ceph osd pool ls detail</p>
<p>pool 4 'kube' replicated size 3 min_size 2 crush_ruleset 0 object_hash rjenkins pg_num 256 pgp_num 256 last_change 2410 flags hashpspool stripe_width 0<br/>
020202 removed_snaps [1~3]</p>
<p><br/>
</p>
<p>2. 在kube存储池创建一个映像文件，就叫vol50，该映像文件的大小为50GB：<br/>
<br/>
rbd create kube/vol50 --size 50000</p>
<p>02rbd -p kube info vol50<br/>
rbd image 'vol50':<br/>
0202 02size 51200 MB in 12800 objects<br/>
0202 02order 22 (4096 kB objects)<br/>
0202 02block_name_prefix: rb.0.754829.238e1f29<br/>
0202 02format: 1<br/>
</p>
<p>3. 创建用户client.kube 用admin用户<br/>
</p>
<p>ceph auth get-or-create client.kube mon 'allow r' osd 'allow class-read class-write object_prefix rbd_children, allow rwx pool=kube' -o ceph.client.kube.keyring</p>
<p>通常我们在ceph install时在ceph.conf中使用默认的安全验证协议 cephx C The Ceph authentication protocol 了。<br/>
</p>
<p>4.02 生成secret<br/>
</p>
<p>得到key(base64)<br/>
</p>
<p>grep key /etc/ceph/ceph.client.kube.keyring |awk '{printf "%s", $NF}'|base64</p>
<p>QVFCK0l4RlpqK0xDTkJBQTRKYVBPTWx6WkFIVVhLK2ozM2lQdUE9PQo=</p>
<p>写secret.yaml：<br/>
</p>
<p>[root@testnew rbd]# cat ceph-secret.yaml<br/>
apiVersion: v1<br/>
kind: Secret<br/>
metadata:<br/>
02 name: ceph-secret<br/>
type: "kubernetes.io/rbd"<br/>
data:<br/>
02 key: QVFCK0l4RlpqK0xDTkJBQTRKYVBPTWx6WkFIVVhLK2ozM2lQdUE9PQo=</p>
<p>02copy /etc/ceph/ceph.client.kube.keyring和ceph.conf到kubernetes的所有节点</p>
<p>kubectl create -f ceph-secret.yaml</p>
<p>[root@testnew ~]# kubectl get secret<br/>
NAME020202020202020202 TYPE020202020202020202020202020202 DATA0202020202 AGE<br/>
ceph-secret0202 kubernetes.io/rbd0202 10202020202020202 13d<br/>
</p>
<p>5. 格式化一个空image<br/>
</p>
<p>格式化一个空image那样对其进行格式化了，这里格成ext4文件系统（格式化这一步可以不需要）</p>
<p>rbd map kube/vol50</p>
<p>rbd info kube/vol50<br/>
</p>
<p>mkfs.ext4 /dev/rbd0</p>
<p>rbd unmap /dev/rbd0<br/>
</p>
<p>6. 创建pod with RBD</p>
<p>[root@testnew kube]# cat frontend-rbd-controller.yaml<br/>
apiVersion: v1<br/>
kind: ReplicationController<br/>
metadata:<br/>
02 name: frontendrbd1<br/>
02 labels:<br/>
020202 name: frontendrbd1<br/>
spec:<br/>
02 replicas: 1<br/>
02 selector:<br/>
020202 name: frontendrbd1<br/>
02 template:<br/>
020202 metadata:<br/>
0202020202 labels:<br/>
02020202020202 name: frontendrbd1<br/>
020202 spec:<br/>
0202020202 containers:<br/>
0202020202 - name: frontendrbd1<br/>
02020202020202 image: kubeguide/guestbook-php-frontend<br/>
02020202020202 env:<br/>
02020202020202 - name: GET_HOSTS_FROM<br/>
020202020202020202 value: env<br/>
02020202020202 ports:<br/>
02020202020202 - containerPort: 80<br/>
02020202020202 volumeMounts:<br/>
02020202020202 - mountPath: /mnt/rbd<br/>
020202020202020202 name: rbdpb<br/>
0202020202 volumes:<br/>
0202020202 - name: rbdpb<br/>
02020202020202 rbd:<br/>
020202020202020202 monitors:<br/>
020202020202020202 - 10.0.200.11:6789<br/>
020202020202020202 - 10.0.200.13:6789<br/>
020202020202020202 - 10.0.200.14:6789<br/>
020202020202020202 pool: kube<br/>
020202020202020202 image: vol50<br/>
020202020202020202 user: kube<br/>
020202020202020202 secretRef:<br/>
02020202020202020202020202 name: ceph-secret<br/>
020202020202020202 fsType: ext4<br/>
020202020202020202 readOnly: false</p>
<p>kubectl create -f frontend-rbd-controller.yaml</p>
<p>[root@testnew ~]# kubectl get rc<br/>
NAME0202020202020202020202 DESIRED0202 CURRENT0202 READY02020202 AGE<br/>
frontendrbd1020202 10202020202020202 10202020202020202 10202020202020202 13d<br/>
<br/>
[root@testnew ~]# kubectl get pods<br/>
NAME0202020202020202020202020202020202 READY02020202 STATUS020202 RESTARTS0202 AGE<br/>
frontendrbd1-h9z78020202 1/1020202020202 Running0202 1020202020202020202 13d</p>
<p>7. 验证volume在container里。</p>
<p>[root@testnew ~]# kubectl exec frontendrbd1-h9z78 -it bash<br/>
root@frontendrbd1-h9z78:/var/www/html# df -k<br/>
Filesystem0202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202 1K-blocks02020202 Used Available Use% Mounted on<br/>
/dev/mapper/docker-253:1-530097-861967a5b3b1a5f40b4880db1921a52af2656a10bf5ce9d1727c40845a4aa9c202 104744960202 6230840202 98514120202 6% /<br/>
tmpfs020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202 408771202020202020202 00202 40877120202 0% /dev<br/>
tmpfs020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202 408771202020202020202 00202 40877120202 0% /sys/fs/cgroup<br/>
<span style="color:#FF0000">/dev/rbd002020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202 51474912 1684093602 3199615202 35% /mnt/rbd</span><br/>
/dev/vda102020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202 19593296 151449800202 357746002 81% /etc/hosts<br/>
shm02020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202 6553602020202020202 002020202 655360202 0% /dev/shm<br/>
<br/>
<br/>
</p>
<p><br/>
</p>
<p><br/>
</p>
<p><br/>
</p>
<p><br/>
<br/>
</p>
   
</div>